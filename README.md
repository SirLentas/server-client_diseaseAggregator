# server-client_diseaseAggregator
A disease aggregator based on server-client communication

Δημιουργία εκτελέσιμου:
=======================
Η δημιουργία του εκτελέσιμου γίνεται με την κληση της εντολής make.


Κλήση εφαρμογής:
================
Η εφαρμογή καλείται με τις εξής εντολες:

./whoServer –q queryPortNum -s statisticsPortNum –w numThreads –b bufferSize
./master –w numWorkers -b bufferSize –s serverIP –p serverPort -i input_dir
./whoClient –q queryFile -w numThreads –sp servPort –sip servIP

Παράδειγματα : 
    $  ./whoServer -w 10 -s 4001 -q 4005 -b 5
    $  ./master -b 10 -w 8 -i ./input/ -s 127.0.0.1 -p 4001
    $  ./whoClient -sip 127.0.0.1 -sp 4005 -w 3 -q ./input_queries

  Τα μέλη καθε εντολής μπορούν να δωθούν με οποιαδήποτε σειρά αρκεί να βρίσκονται μετά το αντίστοιχο flag .


Λειτουργία:
===========
Ο master ειναι αυτος που αναλογα με το numWorkers δημιουργει διεργασιες με fork() και εκτελει το worker με την χρήση της execvp().
O worker καλειτε ως εξης : ./worker fifo_in fifo_out workload input_dir buffersize

Ο master ειναι αυτος που δημιουργει τα named pipes και γραφει για καθε worker τις χωρες που πρεπει να διαβασει.
Οι workers διαβαζουν τη χωρα, ανοιγουν τους φακελους και εισαγουν σε μια λιστα τις ημερομηνιες/αρχεια. Στη συνεχεια ανοιγουν τις ημερμηνιες, διαβαζουν τις
εγγραφες που τις εισαγουν σε μια λιστα, εξαγουν καταλληλα μυνηματα στο error_report.xxx (xxx το pid του) για σωστη εισοδο μιας εγγραφης ή καποιου λαθος σε εγγραφες exit
και δημιουργει τα summaries για το whoServer. Τα summaries εχουν μορφη [ Ημερομηνια / Χώρα / Ασθενεια / κρουσματα 0-20 / 21-40 / 41-60/ 60+ ]
Αφου δημιουργησει τα summaries για ολες τις χωρες που του εχουν ανατεθει ενημερωνει τον whoServer για να ξεκινησουν επικοινωνια. Το thread που διαβαζει στο summaries 
port βαζει τον file descriptor στο buffer. Οταν καποιο thread διαβασει το fd απο το buffer διαβαζει τον αριθμο summary που θα του στειλει ο worker.
Μετα απο την αναγνωση των summaries στον whoServer ο τελευταιος τα τοποθετει σε μια λιστα και περιμενει νεα αιτηματα σε καποιο port.
Αν λαβει καποιο αιτημα στο query port εισαγει το file descriptor στο buffer. Απο εκει το διαβαζει καποιο thread-consumer ο οποιος εκτελει το καθε query οπως αναλυεται στη συνεχεια.

Το προγραμμα whoServer τερματιζει μεσω ενος σηματος SIGINT που γινεται handle και τερματιζει και τους worker (και τον master).

>> Η επικοινωνια μεταξυ των threads του whoServer βασιζονται στο παραδειγμα των καταναλωτων/παραγωγων που υπαρχει στα code samples του μαθηματος.


Πρωτοκολλο επικοινωνιας:
========================
Δημιουργεια δομων
-----------------
  1/ O master γραφει εναν int για τον αριθμο chunks που αποτελουν ενα μυνημα/χωρα.
  2/ O worker εναν int για τον αριθμο chunks που αποτελουν ενα μυνημα/χωρα και γραφει εναν int ωστε να συνεχισει ο diseaseAggregator.
  3/ O master διαβαζει το οκ και γραφει ενα ενα τα chunk, για καθε chunk περιμενει απο τον worker το οκ.
  4/ Ο worker επεξεργαζεται τους φακελους και στελνει εναν int στο whoServer για τον αριθμο των summaries που θα στείλει.
  5/ O worker στέλνει 1-1 τα summaries και ο server τα αποθηκεύει σε δομες.


Πολιτικη διεκπερεωσης των ερωτηματων και επικοινωνια προγραμματων:
==================================================================

  > /diseaseFrequency virusName date1 date2 [country]
      O whoServer στελνει το query σε ολους τους workers. O καθε worker στελνει τον αριθμο τον κρουσματων για την ασθενεια που δοθηκε, στη συγκεκριμενη χωρα ή συνολικα αν 
      δεν δοθηκε ορισμα country. Ο whoServer τα αθροιζει και στελνει το συνολικο αριθμο στο whoClient.

  > /topk-AgeRanges k country disease date1 date2
      O whoServer στελνει το query σε ολους τους workers. Αν ο worker εξυπηρετει τη χωρα αυτη στελνει 1 και μετα τον αριθμο των κρουσματων ανα ηλικιακη κατηγορια στο whoServer.
      Αυτος στη συνεχεια στέλνει το μεγιστο k φορες στο whoClient ο οποιος τα εμφανιζει.

  > /searchPatientRecord recordID
      Ο whoServer προωθεί σε όλους τους Workers το αίτημα απάντηση απο ολους, αν ολοι επιστρεψουν αρνητικη απαντηση στέλνει στο whoClient καταλληλο μηνυμα, αλλιως οποιος worker 
      βρηκε την εγγραφη την εστειλε στο whoServer, αφου επιστρεψουν το αποτελεσμα τους ολοι οι worker στελενι το καταλληλο μυνημα στο whoClient.

  > /numPatientAdmissions disease date1 date2 [country] και /numPatientDischarges disease date1 date2 [country]
      O whoServer στελνει το query σε ολους τους workers. Αν εχει δοθει country περιμενει την απαντηση του καθε worker για το αν εξυπηρετει αυτη την χωρα, αν ειναι θετικο στελνει 
      την απαντηση του και ο whoServer την στελνει στο whoClient. Αν δεν δοθηκε ορισμα country τοτε ο καθε worker στελνει τον αριθμο των χωρων που εξυπηρετει και για την καθε χωρα 
      στελνει μια απαντηση, καθε μηνυμα που διαβαζει ο whoServer το στελνει στο whoClient. Αφου διαβασει απο ολους τους worker στελνει στον whoClient μηνυμα "end of countries" για 
      να τον ενημερωσει να σταματησει να διαβαζει.


Δομες:
======
Οι δομες που εχουν υλοποιηθει για της χωρες στο master, για τις εγγραφες, τα summaries και της ημερομηνιες στο worker ειναι μονα συνδεδεμενες λιστες.
Τα summaries αποθηκευονται μονο στους worker, ο whoServer λαμβανει απλα τα summaries και τα εκτυπωνει χωρις να τα αποθηκεύει.

Το κυκλικο buffer περιέχει 2 πινακες ακεραιων, 1 για τα file descriptors των ανοιγμένων socket και 1 για τον τυπο του socket (0 αν ειναι socket για διαβασμα απο worker ή 1 αν ειναι 
socket για διάβασμα query). Επίσης περιεχει εναν ακεραιο για τη θεση οπου θα γινει η επομενη εισαγωγη, 1 για την θεση που θα γινει η επομενη εξαγωγη και 1 counter για τα στοιχεία 
που βρίσκονται μεσα στο buffer.

Έξοδος στο tty:
===============
Στο tty ο whoClient γραφει τα αποτελεσματα των εντολων.
Στο tty ο whoServer και ο master γραφουν, ο καθενας στο δικο του, μηνυματα σχετικα με την λειτουργια τους.

Αρχεια εξοδου:
==============
Στο φακελο error_reports εμφανιζονται για καθε worker ενα αρχειο που αφορα τις εγγραφες.
